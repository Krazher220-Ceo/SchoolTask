#!/usr/bin/env node
/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –º–∏–≥—Ä–∞—Ü–∏–π Prisma
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Vercel build –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π
 */

const { execSync } = require('child_process')

const failedMigrations = [
  '20251209155927_add_telegram_link_code',
  '20251215120000_add_shop_gamification',
  '20251215130000_add_all_gamification_systems',
]

console.log('üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏—Ö—Å—è –º–∏–≥—Ä–∞—Ü–∏–π...')

try {
  // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
  console.log('üì¶ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π...')
  execSync('npx prisma migrate deploy', { stdio: 'inherit' })
  console.log('‚úÖ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!')
} catch (error) {
  console.log('‚ö†Ô∏è  –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏–µ—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏, —Ä–∞–∑—Ä–µ—à–∞–µ–º...')
  
  // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—Ä–æ–≤–∞–ª–∏–≤—à–∏–µ—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏
  for (const migration of failedMigrations) {
    try {
      console.log(`üîÑ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏: ${migration}`)
      execSync(`npx prisma migrate resolve --rolled-back ${migration}`, { stdio: 'inherit' })
    } catch (e) {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è —É–∂–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞
      console.log(`‚ÑπÔ∏è  –ú–∏–≥—Ä–∞—Ü–∏—è ${migration} —É–∂–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ –∏–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`)
    }
  }
  
  // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–Ω–æ–≤–∞
  console.log('üì¶ –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π...')
  execSync('npx prisma migrate deploy', { stdio: 'inherit' })
  console.log('‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!')
}

