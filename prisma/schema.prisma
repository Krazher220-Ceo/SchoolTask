// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Пользователи системы
model User {
  id               String   @id @default(cuid())
  email            String   @unique
  password         String? // null для внешних пользователей
  name             String
  role             String   @default("STUDENT") // ADMIN, MINISTER, MEMBER, STUDENT
  class            String? // Класс ученика (только цифра, например "9")
  classLetter      String? // Литер класса (например "Д", без кавычек)
  fullClass        String? // Полный класс (например "9Д") - вычисляется автоматически
  avatar           String?
  telegramId       String?  @unique // Telegram ID для бота
  telegramUsername String? // Telegram username
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Связи
  parliamentMember             ParliamentMember?
  tasksAssigned                Task[]                 @relation("TaskAssignedTo")
  tasksCreated                 Task[]                 @relation("TaskCreatedBy")
  taskReports                  TaskReport[]
  studentReports               StudentReport[]
  reviewedReports              StudentReport[]        @relation("StudentReportReviewer")
  xpHistory                    XPHistory[]
  badges                       UserBadge[]
  eventPoints                  EventPoint[]
  achievements                 Achievement[]
  complimentsSent              Compliment[]           @relation("ComplimentSender")
  complimentsReceived          Compliment[]           @relation("ComplimentReceiver")
  mentors                      Mentor[]               @relation("Mentor")
  mentees                      Mentor[]               @relation("Mentee")
  quests                       QuestProgress[]
  ratings                      Rating[]
  telegramNotifications        TelegramNotification[]
  registrationRequest          RegistrationRequest?
  publicTaskInstances          PublicTaskInstance[]
  reviewedRegistrationRequests RegistrationRequest[]  @relation("RegistrationRequestReviewer")
  reviewedPublicTaskInstances  PublicTaskInstance[]   @relation("PublicTaskInstanceReviewer")
  eventsCreated                Event[]                @relation("EventCreatedBy")
  telegramLinkCodes            TelegramLinkCode[]
  assignedQuests               AssignedQuest[]
  passwordResetCodes           PasswordResetCode[]
  duelsOpponent                Duel[]                 @relation("DuelOpponent")
  duelsWon                     Duel[]                 @relation("DuelWinner")
  purchases                    UserPurchase[]
  visualEffects                UserVisualEffects?
  loginStreak                  LoginStreak?
  spotlight                    Spotlight?
  feedEvents                   FeedEvent[]
  duelsCreated                 Duel[]                    @relation("DuelCreator")
  duelsParticipated            DuelParticipant[]
  challengesCreated            Challenge[]               @relation("ChallengeCreator")
  challengeParticipants         ChallengeParticipant[]
  guildMembers                 GuildMember[]
  guildsCreated                Guild[]                    @relation("GuildCreator")
  seasonRatings                SeasonRating[]
  recommendations              Recommendation[]

  @@index([email])
  @@index([telegramId])
}

// Члены парламента
model ParliamentMember {
  id       String   @id @default(cuid())
  userId   String   @unique
  ministry String // LAW_AND_ORDER, INFORMATION, SPORT, CARE
  position String? // Должность (министр, участник, мобилограф)
  shift    String? // Смена (1 смена, 2 смена)
  xp       Int      @default(0)
  level    Int      @default(1)
  rank     String   @default("Новичок")
  joinedAt DateTime @default(now())
  isActive Boolean  @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([ministry])
  @@index([xp])
}

// Задачи
model Task {
  id             String    @id @default(cuid())
  title          String
  description    String
  ministry       String? // LAW_AND_ORDER, INFORMATION, SPORT, CARE, null для задач ученикам
  assignedToId   String?
  createdById    String
  status         String    @default("NEW") // NEW, IN_PROGRESS, IN_REVIEW, COMPLETED, REJECTED
  priority       String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  deadline       DateTime?
  xpReward       Int       @default(10) // Для участников парламента
  epReward       Int? // Для учеников (EP)
  targetAudience String    @default("PARLIAMENT_MEMBER") // PARLIAMENT_MEMBER, STUDENT, PUBLIC
  taskType       String    @default("PRIVATE") // PRIVATE (назначена конкретному), PUBLIC (общественная - каждый берет свою копию)
  topRanking     Int? // Для общественных задач: 3, 5, 10 - количество мест в топе (null = без рейтинга)
  selectedTopInstances String? // JSON массив ID выбранных инстансов в топе (до дедлайна)
  topAwarded     Boolean   @default(false) // Флаг, что топ награжден (после дедлайна)
  tags           String? // JSON массив тегов
  attachments    String? // JSON массив ссылок
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  assignedTo          User?                @relation("TaskAssignedTo", fields: [assignedToId], references: [id])
  createdBy           User                 @relation("TaskCreatedBy", fields: [createdById], references: [id])
  guild               Guild?               @relation("GuildTask", fields: [guildId], references: [id], onDelete: SetNull)
  guildId             String?
  reports             TaskReport[]
  studentReports      StudentReport[]
  publicTaskInstances PublicTaskInstance[] // Инстансы общественных задач

  @@index([ministry])
  @@index([status])
  @@index([assignedToId])
  @@index([targetAudience])
  @@index([taskType])
  @@index([guildId])
}

// Отчеты по задачам
model TaskReport {
  id          String   @id @default(cuid())
  taskId      String
  userId      String
  description String
  photos      String? // JSON массив ссылок
  videos      String? // JSON массив ссылок
  links       String? // JSON массив ссылок
  timeSpent   Int? // Минуты
  status      String   @default("PENDING") // PENDING, APPROVED, NEEDS_REVISION, REJECTED
  quality     Int? // 1-5 звезд
  feedback    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([status])
}

// История начисления XP
model XPHistory {
  id        String   @id @default(cuid())
  userId    String
  amount    Int
  reason    String
  source    String? // task, quest, bonus, etc.
  sourceId  String? // ID источника (taskId, questId)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

// Бейджи
model Badge {
  id          String  @id @default(cuid())
  name        String  @unique
  description String
  icon        String
  rarity      String  @default("COMMON") // COMMON, RARE, EPIC, LEGENDARY
  category    String
  condition   String? // JSON условие для получения

  userBadges UserBadge[]
}

// Бейджи пользователей
model UserBadge {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

// Баллы за мероприятия (для всех учеников)
model EventPoint {
  id        String   @id @default(cuid())
  userId    String
  amount    Int
  reason    String
  eventId   String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// Достижения
model Achievement {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String
  icon        String?
  earnedAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// Комплименты
model Compliment {
  id        String   @id @default(cuid())
  fromId    String
  toId      String
  message   String
  type      String // "thanks", "great_work", "inspire"
  createdAt DateTime @default(now())

  from User @relation("ComplimentSender", fields: [fromId], references: [id])
  to   User @relation("ComplimentReceiver", fields: [toId], references: [id])

  @@index([toId])
}

// Менторство
model Mentor {
  id        String    @id @default(cuid())
  mentorId  String
  menteeId  String
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  isActive  Boolean   @default(true)

  mentor User @relation("Mentor", fields: [mentorId], references: [id])
  mentee User @relation("Mentee", fields: [menteeId], references: [id])

  @@unique([mentorId, menteeId])
  @@index([mentorId])
  @@index([menteeId])
}

// Квесты
model Quest {
  id          String    @id @default(cuid())
  name        String
  description String
  type        String // DAILY, WEEKLY, MONTHLY, SEASONAL, EVENT
  xpReward    Int       @default(0) // Для участников парламента
  epReward    Int       @default(0) // Для учеников
  condition   String // JSON условие
  isActive    Boolean   @default(true)
  startsAt    DateTime?
  endsAt      DateTime?
  createdAt   DateTime  @default(now())

  progress       QuestProgress[]
  assignedQuests AssignedQuest[]
}

// Назначенные задания ученикам (для отслеживания случайных заданий)
model AssignedQuest {
  id          String    @id @default(cuid())
  questId     String
  userId      String
  assignedAt  DateTime  @default(now())
  period      String // 'daily', 'weekly', 'monthly' - для группировки
  periodDate  DateTime // Дата периода (для ежедневных - дата дня, для недельных - начало недели, для месячных - начало месяца)
  completed   Boolean   @default(false)
  completedAt DateTime?

  quest Quest @relation(fields: [questId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([questId, userId, periodDate]) // Одно задание не может быть назначено дважды в один период
  @@index([userId, period, periodDate])
  @@index([period, periodDate])
}

// Прогресс по квестам
model QuestProgress {
  id          String    @id @default(cuid())
  questId     String
  userId      String
  progress    Int       @default(0)
  target      Int
  completed   Boolean   @default(false)
  completedAt DateTime?

  quest Quest @relation(fields: [questId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@unique([questId, userId])
  @@index([userId])
}

// Рейтинги
model Rating {
  id        String   @id @default(cuid())
  userId    String
  type      String // XP, EP
  period    String // "month", "quarter", "year", "all"
  position  Int
  value     Int // XP или EP
  ministry  String? // LAW_AND_ORDER, INFORMATION, SPORT, CARE
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([type, period, position])
}

// Мероприятия
model Event {
  id              String   @id @default(cuid())
  title           String
  description     String
  ministry        String? // LAW_AND_ORDER, INFORMATION, SPORT, CARE
  category        String
  date            DateTime
  location        String?
  maxParticipants Int?
  status          String   @default("UPCOMING") // UPCOMING, IN_PROGRESS, COMPLETED, CANCELLED
  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  createdBy    User               @relation("EventCreatedBy", fields: [createdById], references: [id])
  participants EventParticipant[]
  photos       String? // JSON массив ссылок
}

// Участники мероприятий
model EventParticipant {
  id           String   @id @default(cuid())
  eventId      String
  userId       String
  registeredAt DateTime @default(now())
  attended     Boolean  @default(false)
  epEarned     Int      @default(0)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
}

// Идеи от учеников
model Idea {
  id            String   @id @default(cuid())
  title         String
  description   String
  category      String
  submittedById String
  status        String   @default("PENDING") // PENDING, REVIEWING, APPROVED, REJECTED, IMPLEMENTED
  ministry      String? // LAW_AND_ORDER, INFORMATION, SPORT, CARE
  feedback      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status])
  @@index([submittedById])
}

// Отчеты учеников (фото баллов, СОРы и т.д.)
model StudentReport {
  id             String   @id @default(cuid())
  userId         String
  taskId         String? // Если это отчет по задаче
  type           String // "GRADE_PHOTO", "SOR", "TASK_COMPLETION"
  subject        String? // Предмет (для GRADE_PHOTO, SOR)
  grade          Int? // Балл за предмет (10 баллов = 9 EP)
  description    String?
  photoUrl       String // Ссылка на фото
  telegramFileId String? // ID файла в Telegram
  epAmount       Int? // Начисленные EP (рассчитывается автоматически)
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED
  feedback       String?
  reviewedById   String? // Кто проверил
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user       User  @relation(fields: [userId], references: [id])
  task       Task? @relation(fields: [taskId], references: [id], onDelete: SetNull)
  reviewedBy User? @relation("StudentReportReviewer", fields: [reviewedById], references: [id])

  @@index([userId])
  @@index([status])
  @@index([type])
}

// Telegram уведомления
model TelegramNotification {
  id        String    @id @default(cuid())
  userId    String
  type      String // "TASK_ASSIGNED", "TASK_REMINDER", "REPORT_APPROVED", "REPORT_REJECTED"
  message   String
  taskId    String?
  reportId  String?
  sent      Boolean   @default(false)
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([sent])
}

// Коды восстановления пароля
model PasswordResetCode {
  id        String   @id @default(cuid())
  userId    String
  code      String   // 6-значный код
  expiresAt DateTime // Время истечения (10 минут)
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, code])
  @@index([userId])
  @@index([code])
  @@index([expiresAt])
}

// Заявки на регистрацию
model RegistrationRequest {
  id              String    @id @default(cuid())
  fullName        String // ФИО
  phone           String // Телефон
  email           String // Почта
  login           String // Логин
  bilimClassLogin String? // Логин от Bilim class
  class           String? // Класс (например "9")
  classLetter     String? // Литер (например "Д", без кавычек)
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewedById    String? // Кто рассмотрел
  reviewedAt      DateTime?
  feedback        String? // Комментарий при отклонении
  userId          String?   @unique // ID созданного пользователя (если одобрено)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  reviewer User? @relation("RegistrationRequestReviewer", fields: [reviewedById], references: [id])
  user     User? @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([email])
  @@index([login])
}

// Инстансы общественных задач (каждый пользователь берет свою копию)
model PublicTaskInstance {
  id           String   @id @default(cuid())
  taskId       String
  userId       String
  status       String   @default("NEW") // NEW, IN_PROGRESS, IN_REVIEW, COMPLETED, REJECTED
  videoUrl     String? // Ссылка на видео (через Telegram)
  workLink     String? // Ссылка на работу
  description  String? // Описание выполненной работы
  feedback     String?
  reviewedById String?
  topPosition  Int? // Позиция в топе (1, 2, 3, ...) - устанавливается админом до дедлайна
  topAwarded    Boolean @default(false) // Флаг, что награда за топ начислена
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  task     Task  @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user     User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer User? @relation("PublicTaskInstanceReviewer", fields: [reviewedById], references: [id])

  @@unique([taskId, userId]) // Один пользователь может взять задачу только один раз
  @@index([taskId])
  @@index([userId])
  @@index([status])
}

// Статистика для главной страницы
model SiteStats {
  id          String   @id @default(cuid())
  key         String   @unique // 'events_count', 'members_count', 'ideas_count'
  value       String // Значение (может быть число или текст)
  description String? // Описание
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Коды подтверждения для привязки Telegram аккаунта
model TelegramLinkCode {
  id         String   @id @default(cuid())
  userId     String // ID пользователя на сайте
  telegramId String // Telegram ID пользователя
  code       String // 6-значный код подтверждения
  expiresAt  DateTime // Время истечения (10 минут)
  used       Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([code])
  @@index([userId])
  @@index([telegramId])
  @@index([code])
}

// Товары в магазине
model ShopItem {
  id          String   @id @default(cuid())
  name        String
  description String
  category    String // NICKNAME_COLOR, AVATAR_BORDER, CUSTOM_TITLE, SPOTLIGHT, STREAK_FREEZE
  price       Int // Цена в EP
  duration    Int // Длительность в днях (0 = навсегда)
  data        String // JSON с данными товара (цвета, варианты и т.д.)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases UserPurchase[]

  @@index([category])
  @@index([isActive])
}

// Покупки пользователей
model UserPurchase {
  id          String   @id @default(cuid())
  userId      String
  shopItemId  String
  expiresAt  DateTime? // null если навсегда
  isActive   Boolean  @default(true)
  purchasedAt DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  shopItem ShopItem @relation(fields: [shopItemId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([shopItemId])
  @@index([expiresAt])
  @@index([isActive])
}

// Визуальные эффекты пользователя (активные)
model UserVisualEffects {
  id              String   @id @default(cuid())
  userId          String   @unique
  nicknameColor   String? // JSON с цветом/градиентом
  avatarBorder    String? // JSON с типом рамки
  customTitle     String? // Кастомный титул
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Стрики входа
model LoginStreak {
  id              String   @id @default(cuid())
  userId          String   @unique
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActivityAt  DateTime @default(now())
  freezeUsed      Boolean  @default(false) // Использована ли заморозка стрика
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Битва министерств (ежедневная статистика)
model MinistryWar {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  ministry    String // LAW_AND_ORDER, INFORMATION, SPORT, CARE
  epEarned    Int      @default(0) // EP заработанные за день
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date, ministry])
  @@index([date])
  @@index([ministry])
}

// Закреп на главной странице (Spotlight)
model Spotlight {
  id          String   @id @default(cuid())
  userId      String   @unique
  quote       String? // Цитата пользователя
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
}

// Лента событий
model FeedEvent {
  id          String   @id @default(cuid())
  userId      String
  type        String // task_completed, achievement_unlocked, rank_up, duel_update, challenge_progress, streak_milestone, shop_purchase, record_broken
  title       String
  description String
  data        String? // JSON с дополнительными данными
  category    String? // competitive, collaborative, social, economy
  highlight   Boolean  @default(false)
  pinned      Boolean  @default(false)
  likes       Int      @default(0)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([category])
  @@index([createdAt])
  @@index([highlight])
  @@index([pinned])
}

// Дуэли
model Duel {
  id          String   @id @default(cuid())
  creatorId   String
  opponentId  String
  stake       Int // EP ставка каждого участника
  duration    Int // Длительность в днях
  category    String? // Любые задачи, спортивные, творческие и т.д.
  status      String   @default("PENDING") // PENDING, ACTIVE, COMPLETED, CANCELLED
  creatorScore Int     @default(0)
  opponentScore Int    @default(0)
  winnerId    String?
  startedAt   DateTime?
  endsAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator  User                @relation("DuelCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  opponent User                @relation("DuelOpponent", fields: [opponentId], references: [id], onDelete: Cascade)
  winner   User?               @relation("DuelWinner", fields: [winnerId], references: [id])
  participants DuelParticipant[]

  @@index([creatorId])
  @@index([opponentId])
  @@index([status])
  @@index([endsAt])
}

model DuelParticipant {
  id        String   @id @default(cuid())
  duelId    String
  userId    String
  score     Int      @default(0)
  joinedAt  DateTime @default(now())

  duel Duel @relation(fields: [duelId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([duelId, userId])
  @@index([userId])
}

// Челленджи
model Challenge {
  id              String   @id @default(cuid())
  creatorId       String
  title            String
  description      String
  type            String // CLASS, SCHOOL, INTER_CLASS
  targetEP        Int // Целевое количество EP
  currentEP       Int      @default(0)
  reward          String // Описание награды
  status          String   @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  startsAt        DateTime @default(now())
  endsAt          DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  creator         User                  @relation("ChallengeCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  participants    ChallengeParticipant[]

  @@index([creatorId])
  @@index([type])
  @@index([status])
  @@index([endsAt])
}

model ChallengeParticipant {
  id          String   @id @default(cuid())
  challengeId String
  userId      String
  epContributed Int    @default(0)
  joinedAt    DateTime @default(now())

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@index([userId])
}

// Гильдии
model Guild {
  id          String   @id @default(cuid())
  name        String
  description String
  icon        String? // Эмодзи или URL иконки
  color       String? // Цвет гильдии
  creatorId   String
  isActive    Boolean  @default(true)
  totalEP     Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator User         @relation("GuildCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  members GuildMember[]
  tasks   Task[]       @relation("GuildTask")

  @@index([isActive])
  @@index([totalEP])
}

model GuildMember {
  id        String   @id @default(cuid())
  guildId   String
  userId    String
  role      String   @default("MEMBER") // LEADER, OFFICER, MEMBER
  epContributed Int   @default(0)
  joinedAt  DateTime @default(now())

  guild Guild @relation(fields: [guildId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([guildId, userId])
  @@index([userId])
  @@index([guildId])
}

// Сезоны
model Season {
  id          String   @id @default(cuid())
  name        String
  startDate   DateTime
  endDate     DateTime
  theme       String?
  bonusCategory String? // Категория с удвоенными баллами
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ratings SeasonRating[]

  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

model SeasonRating {
  id        String   @id @default(cuid())
  seasonId  String
  userId    String
  ep        Int      @default(0)
  position  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  season Season @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([seasonId, userId])
  @@index([seasonId, position])
  @@index([userId])
}

// Рекомендации
model Recommendation {
  id          String   @id @default(cuid())
  userId      String
  type        String // TASK, MINISTRY, GUILD
  itemId      String // ID задачи, министерства или гильдии
  score       Float // Оценка релевантности 0-1
  reason      String? // Причина рекомендации
  shownAt     DateTime?
  clickedAt   DateTime?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, itemId])
  @@index([userId])
  @@index([type])
  @@index([score])
}
